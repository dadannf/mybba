# Azure Container Instances Quick Commands
# =========================================

# View container status
az container show --resource-group mybba-rg --name mybba-web --query "{Name:name,State:instanceView.state,IP:ipAddress.fqdn}" -o table
az container show --resource-group mybba-rg --name mybba-ocr --query "{Name:name,State:instanceView.state,IP:ipAddress.fqdn}" -o table

# View logs
az container logs --resource-group mybba-rg --name mybba-web --tail 50
az container logs --resource-group mybba-rg --name mybba-ocr --tail 50

# View logs in real-time (follow)
az container logs --resource-group mybba-rg --name mybba-web --follow
az container logs --resource-group mybba-rg --name mybba-ocr --follow

# Restart containers
az container restart --resource-group mybba-rg --name mybba-web
az container restart --resource-group mybba-rg --name mybba-ocr

# Stop containers (billing continues)
az container stop --resource-group mybba-rg --name mybba-web
az container stop --resource-group mybba-rg --name mybba-ocr

# Start containers
az container start --resource-group mybba-rg --name mybba-web
az container start --resource-group mybba-rg --name mybba-ocr

# Delete specific container
az container delete --resource-group mybba-rg --name mybba-web --yes
az container delete --resource-group mybba-rg --name mybba-ocr --yes

# Delete entire resource group (all resources)
az group delete --name mybba-rg --yes

# Get container details
az container show --resource-group mybba-rg --name mybba-web
az container show --resource-group mybba-rg --name mybba-ocr

# List all containers in resource group
az container list --resource-group mybba-rg -o table

# Update environment variables (requires recreate)
az container create --resource-group mybba-rg --name mybba-web --image ... --environment-variables KEY=VALUE

# Execute command in running container
az container exec --resource-group mybba-rg --name mybba-web --exec-command "/bin/bash"

# View container events
az container show --resource-group mybba-rg --name mybba-web --query instanceView.events

# Export container logs to file
az container logs --resource-group mybba-rg --name mybba-web > web-logs.txt
az container logs --resource-group mybba-rg --name mybba-ocr > ocr-logs.txt

# Check container resource usage
az monitor metrics list --resource /subscriptions/{subscription-id}/resourceGroups/mybba-rg/providers/Microsoft.ContainerInstance/containerGroups/mybba-web --metric "CpuUsage"

# Database commands
# ==================

# Connect to MySQL
mysql -h mybba-mysql-server.mysql.database.azure.com -u mybbaadmin -p dbsekolah

# Import database
mysql -h mybba-mysql-server.mysql.database.azure.com -u mybbaadmin -p dbsekolah < database/backups/dbsekolah.sql

# Export database
mysqldump -h mybba-mysql-server.mysql.database.azure.com -u mybbaadmin -p dbsekolah > backup-$(Get-Date -Format "yyyyMMdd").sql

# Show databases
mysql -h mybba-mysql-server.mysql.database.azure.com -u mybbaadmin -p -e "SHOW DATABASES;"

# Update firewall rule to allow your current IP
$myIP = (Invoke-WebRequest -Uri "https://api.ipify.org").Content
az mysql flexible-server firewall-rule create --resource-group mybba-rg --name mybba-mysql-server --rule-name AllowMyIP --start-ip-address $myIP --end-ip-address $myIP

# Container Registry commands
# ============================

# Login to ACR
az acr login --name mybbaregistry

# List images in registry
az acr repository list --name mybbaregistry -o table

# Show image tags
az acr repository show-tags --name mybbaregistry --repository mybba-web -o table
az acr repository show-tags --name mybbaregistry --repository mybba-ocr -o table

# Delete image from registry
az acr repository delete --name mybbaregistry --image mybba-web:old-tag --yes

# Get ACR credentials
az acr credential show --name mybbaregistry

# Update images
# =============

# Build new image
docker build -t mybbaregistry.azurecr.io/mybba-web:v2 .

# Push new image
docker push mybbaregistry.azurecr.io/mybba-web:v2

# Update container with new image
az container delete --resource-group mybba-rg --name mybba-web --yes
az container create --resource-group mybba-rg --name mybba-web --image mybbaregistry.azurecr.io/mybba-web:v2 [... other parameters ...]

# Cost monitoring
# ===============

# View current month costs
az consumption usage list --start-date $(Get-Date -Format "yyyy-MM-01") --end-date $(Get-Date -Format "yyyy-MM-dd") -o table

# View resource group costs
az cost-management query --type ActualCost --dataset-filter "{\"and\":[{\"dimensions\":{\"name\":\"ResourceGroup\",\"operator\":\"In\",\"values\":[\"mybba-rg\"]}}]}" --timeframe MonthToDate

# Troubleshooting
# ===============

# Check if containers are running
az container list --resource-group mybba-rg --query "[].{Name:name,State:instanceView.state,IP:ipAddress.ip}" -o table

# Get detailed error messages
az container show --resource-group mybba-rg --name mybba-web --query instanceView.events

# Test connectivity
curl http://mybba-web-XXXX.southeastasia.azurecontainer.io
curl http://mybba-ocr-XXXX.southeastasia.azurecontainer.io:8000/health

# View Azure Activity Log
az monitor activity-log list --resource-group mybba-rg --start-time $(Get-Date).AddHours(-1).ToString("yyyy-MM-ddTHH:mm:ss") -o table
